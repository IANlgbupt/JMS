## 企业系统中JMS的最佳实践 

### 实际业务场景
   ![实际业务](https://github.com/Letitmiss/JMS/blob/master/img/fenxi1.jpg)
1. 分析
* 登录系统发出登录消息，积分系统和日志系统都要感知到这个事件，类似订阅消息模式
* 积分系统和日志系统为集群，只需要保证一台收到消息，这个类似队列消息模式
* 必须保证执行登录时发布消息成功和订阅消息成功
2. 特点
* 子业务系统都有集群的可能性
* 同一个消息会广播给关注该类消息的所有子业务系统
* 通一类消息在集群中被负载消费
* 业务的发生和消息的发布最终一致性

### 需要解决的问题 

#### 1. 不同业务系统分别处理同一个消息，同一个业务系统负载处理同类消息
#### 2. 解决消息发布时与业务的一致性问题
#### 3. 解决消息处理时的幂等性问题
#### 4. 基于消息机制建立事件总线

### 问题1 解决方案
 #### 方案1 ：中转器
 
 ![中转器](https://github.com/Letitmiss/JMS/blob/master/img/zhongzhuan.jpg)
 
 * 通过中转器订阅JMS主题消息模式，保证两个子系统都可以订阅到发布的消息，中转器将订阅的消息生产出队列消息模式，子系统集群可以消费队列消息，保证集群系统不会收到重复的消息
* 问题：中转器的开发，增加了工作量，每一个系统之间的交互都要开发一个中转器，而且必须保证中转器的高可用
#### 方案2 ：虚拟主题

1. **发布者** : 将消息发布到一个主题中，主题名以VirtualTopic开头 例如 VirtualTopic.TEST

2. **消费者** ：从队列中获取消息，在队列名中表明自己的身份，如：Consumer.A.VirtualTopic.TEST

### 问题2 消息一致性解决
#### 方案1 分布式事物保证强一致性
* 强一致性:同一时间 要不都成功，要不都失败; 弱一致性：对时间无具体要求，随着时间，最终保证数据一致
* 通过 JMS中的XA系列接口引入分布式事务
* 要求业务操作必须支持XA协议
* 缺点 ：互联网项目中不要求强一致性，要求性能高，分布式事物降低了性能，所以这种方法一般不可取
#### 方案2 使用消息表的本地事务

  ![消息表的本地事务](https://github.com/Letitmiss/JMS/blob/master/img/yizhi2.jpg)

1. 通过本地事物将业务和消息组合，保证业务和消息执行的一致性
2. 本地事物接收请求，处理并发送消息到消息中间件，消息中间件检测消息发布成功，更新消息状态
3. 如果消息发送失败，就存在待发送消息，加入消息补偿机制，消息补偿会轮询发送未成功的消息，将未成功消息发送到消息中间件，消息中间件更新消息发送状态
4. 这种方案要求业务和消息都要基于数据库，保证消息不会丢失，操作数据库会增加数据库的I/O，降低性能。

#### 方案3 内存日志解决

    ![内存日志解决](https://github.com/Letitmiss/JMS/blob/master/img/yizhi1.jpg)
    
1. 处理业务并且记录内存日志，发送消息，消息中件发送成功，消息从日志中移出；
2. 发送消息失败是提供消息补偿机制
3. 内存日志可以采用Ehcache框架解决，内存消息读取速度快，可以将消息持久化到本地，保证消息不丢失，而且避免了对数据库造成压力


### 问题3 处理消息幂等性解决

* **幂等性**：就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。举个最简单的例子，那就是支付，用户购买商品使用约支付，支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额返发现多扣钱了，流水记录也变成了两条．．．


#### 方案1 本地事物解决消息处理

![本地事物](https://github.com/Letitmiss/JMS/blob/master/img/mi1.jpg)

1. 消费者接收消息，一般情况下消息会带有id唯一标识属性，根据唯一标识属性查看这个消息是否被被处理过
2. 消息已经处理过，不处理业务，直接接返回消息确认
3. 如果消息未处理过，则执行处理业务，返回消息确认
4. 本地事物会基于数据库，造成数据库查询压力

#### 方案2 内存日志解决方案

![内存日志](https://github.com/Letitmiss/JMS/blob/master/img/mi1.jpg)

1. 消息处理流程基本如上，采用内存日志解决方案，提高了效率;

### 问题4 事件驱动的消息总线

#### 事件驱动架构
	
1. 简介： [看博客](http://blog.csdn.net/jacks_sure/article/details/52537886)
	[博客](http://www.cnblogs.com/lishijia/p/5475452.html)
	[汤雪华专注DDD](http://www.cnblogs.com/netfocus/) 

2. 时间驱动模型
	 ![模型](https://github.com/Letitmiss/JMS/blob/master/img/shijianzongxian.jpg)

